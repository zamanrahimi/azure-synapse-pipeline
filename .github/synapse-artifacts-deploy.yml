# .github/workflows/synapse-artifacts-deploy.yml
name: Deploy Synapse Artifacts

on:
  push:
    branches: [ workspace_publish ]     # triggers when you click Publish in Synapse Studio
  workflow_dispatch:                    # allow manual runs


jobs:
  deploy-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy workspace artifacts
        uses: azure/synapse-workspace-deployment@v1.9.1   # use the latest stable release
        with:
          # Target environment (the workspace you created in the portal)
          TargetWorkspaceName: synapse-ws-TEST
          resourceGroup: rg-data-test
          environment: 'Azure Public'

          # Publish templates generated by Synapse
          TemplateFile: './workspace_publish/TemplateForWorkspace.json'
          ParametersFile: './workspace_publish/TemplateParametersForWorkspace.json'

          # Optional: override selected parameters (see next section)
          # OverrideArmParameters: './overrides/test.yaml'

          # Auth (service principal on GitHub-hosted runners)
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenantId: ${{ secrets.AZURE_TENANT_ID }}
          clientId: ${{ secrets.AZURE_CLIENT_ID }}
          clientSecret: ${{ secrets.AZURE_CLIENT_SECRET }}

          # Housekeeping
          DeleteArtifactsNotInTemplate: 'true'  # cleans up artifacts removed in source
          managedIdentity: 'false'              # MI only works with self-hosted runners